@inject IQuizAnswerService AnswerService
@inject IUpcomingQuizQuestionService QuestionService
@inject IEloCalculatorService EloCalculatorService

<MudPaper Class="pa-4">
    @if (rounds == null || results == null)
    {
        <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
    }
    else if (!rounds.Any())
    {
        <MudOverlay Visible="true" Class="d-flex justify-center align-center" DarkBackground="true">
            <MudPaper Class="pa-6">
                <MudText Typo="Typo.h6" Align="Align.Center">
                    Must Add Rounds To Enter Results!!!
                </MudText>
            </MudPaper>
        </MudOverlay>
    }
    else
    {
        <MudText Typo="Typo.h5">Rated: @editionRated</MudText>
        <MudTable Items="results" Dense="true" Hover="true" Elevation="0" Bordered="true" Class="mt-4">
            <HeaderContent>
                <MudTh>Rank</MudTh>
                <MudTh>Team</MudTh>
                @foreach (var round in rounds)
                {
                    <MudTh>R @round.Number</MudTh>
                }
                <MudTh>Total</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd>
                    @if (context.Rank == 1)
                    {
                        <MudIcon Color="Color.Warning" Icon="@Icons.Material.Filled.EmojiEvents" />
                    }
                    else if (context.Rank == 2)
                    {
                        <MudIcon Color="Color.Secondary" Icon="@Icons.Material.Filled.EmojiEvents" />
                    }
                    else if (context.Rank == 3)
                    {
                        <MudIcon Color="Color.Info" Icon="@Icons.Material.Filled.EmojiEvents" />
                    }
                    else
                    {
                        @context.Rank
                    }
                </MudTd>
                <MudTd>
                    <div class="d-flex align-items-center">
                        <PublicImage ImageName="@context.Team.ProfileImage" ResourceType="MediaServerResource.Team" CssClass="me-2" RemSize="2" />
                        @context.Team.Name
                        @if (ShouldShowBreakTieButton(context))
                        {
                            <MudIconButton Icon="@Icons.Material.Filled.Upgrade"
                            Color="Color.Success"
                            Size="Size.Small"
                            Class="ms-2"
                            OnClick="@(() => BreakTieAsync(context.Id))" />
                        }
                    </div>
                </MudTd>
                @foreach (var round in rounds)
                {
                    var roundResult = context.Rounds.FirstOrDefault(r => r.RoundId == round.Id);
                    bool isMissing = roundResult == null;
                    bool isBrief = roundResult?.QuizSegmentResults.Count() == 0;

                    <MudTd Class="@(isMissing ? "bg-light-red" : isBrief == true ? "bg-light-orange" : null)" @onclick="() => SelectRound(context.Id, round.Id)">
                        <span>
                            @((roundResult?.Points)?.ToString("0.##", CultureInfo.InvariantCulture) ?? "-")
                        </span>
                    </MudTd>
                }
                <MudTd>@context.TotalPoints.ToString("0.##", CultureInfo.InvariantCulture)</MudTd>
            </RowTemplate>
            <FooterContent>
                <MudTd ColSpan="2"><b>Average</b></MudTd>
                @foreach (var round in rounds)
                {
                    var total = results.Sum(r => r.Rounds.FirstOrDefault(x => x.RoundId == round.Id)?.Points ?? 0);
                    var avg = total / results.Count;
                    <MudTd>@($"{avg:0.##}/{round.Points:0.##}")</MudTd>
                }
                <MudTd>
                    @{
                        var total = results.Sum(r => r.TotalPoints);
                        var maxTotal = rounds.Sum(r => r.Points);
                        var avg = total / results.Count;
                    }
                    @($"{avg:0.##}/{maxTotal:0.##}")
                </MudTd>
            </FooterContent>
        </MudTable>

        <MudButton Variant="Variant.Filled" Color="Color.Secondary" Class="mt-4 ms-2" OnClick="RankTeams" Disabled="@(editionRated)">
            Rank Teams
        </MudButton>

        <MudButton Variant="Variant.Filled" Color="Color.Warning" Class="mt-4 ms-2" OnClick="CalculateRatings" Disabled="@(!canCalculateRank)">
            Calculate Ratings
        </MudButton>

        <MudButton Variant="Variant.Filled" Color="Color.Tertiary" Class="mt-4 ms-2" Href=@($"/team-ranking/{EditionId}")>
            Show Team Rankings
        </MudButton>

        <div class="mt-6" style="display:@(resultId.HasValue && selectedRoundId.HasValue ? "block" : "none")">
            @if (resultId.HasValue && selectedRoundId.HasValue)
            {
                <MudPaper Class="pa-4">
                    <MudText Typo="Typo.h5">
                        @($"{selectedTeam?.Name ?? "Unknown Team"} - Round {selectedRound?.Number ?? 0}")
                    </MudText>

                    @if (tempNewRoundResult?.QuizSegmentResults?.Any() == true)
                    {
                        <MudList T="NewQuizRoundResultDto" Dense="true">
                            @foreach (var segment in selectedRound.QuizSegments)
                            {
                                var segmentResult = GetNewSegmentResult(segment.Id);
                                <MudListItem>
                                    <b>Segment #@segment.Number</b>

                                    <MudList T="QuizAnswerDetailedDto" Dense="true" Class="ms-4">

                                        @foreach (var question in segment.Questions)
                                        {
                                            var answer = GetNewAnswer(segmentResult, question.Id);
                                            <MudListItem>
                                                @if (editable)
                                                {
                                                    <MudStack Row Spacing="2" AlignItems="AlignItems.Center">
                                                        <MudText Class="me-4">@($"#{question.Number} - Answer: {question.Answer}")</MudText>
                                                        <MudTextField T="string" @bind-Value="answer.Answer" Class="me-2" />
                                                        <MudNumericField T="decimal" @bind-Value="answer.Points" Class="me-2" Max="@(question.Points + question.BonusPoints)" />
                                                        <MudText Color="@GetResultColor(answer.Result)">
                                                            @(answer.Result switch
                                                            {
                                                                0 => "Incorrect",
                                                                1 => "Partial",
                                                                2 => "Correct",
                                                                _ => "Unknown"
                                                            })
                                                        </MudText>
                                                    </MudStack>
                                                }
                                                else
                                                {
                                                    <MudText>
                                                        Answer: @question.Answer —
                                                        @answer.Answer — @answer.Points — @answer.Result
                                                    </MudText>
                                                }
                                            </MudListItem>
                                        }
                                    </MudList>

                                    <div class="mt-2">
                                        <b>Bonus Points:</b>
                                        @if (editable)
                                        {
                                            <MudNumericField T="decimal" @bind-Value="segmentResult.BonusPoints" Max="@segment.BonusPoints" />
                                        }
                                        else
                                        {
                                            @segmentResult.BonusPoints
                                        }
                                    </div>
                                </MudListItem>
                            }
                        </MudList>
                    }
                    else if (tempRoundResult?.QuizSegmentResults?.Any() == true)
                    {
                        <MudList T="QuizRoundResultDetailedDto" Dense="true">
                            @foreach (var segment in selectedRound.QuizSegments)
                            {
                                var segmentResult = GetSegmentResult(segment.Id);
                                <MudListItem>
                                    <b>Segment #@segment.Number</b>

                                    <MudList T="QuizAnswerDetailedDto" Dense="true" Class="ms-4">

                                        @foreach (var question in segment.Questions)
                                        {
                                            var answer = GetAnswer(segmentResult, question.Id);
                                            <MudListItem>
                                                @if (editable)
                                                {
                                                    <MudStack Row Spacing="2" AlignItems="AlignItems.Center">
                                                        <MudText Class="me-4">@($"#{question.Number} - Answer: {question.Answer}")</MudText>
                                                        <MudTextField T="string" @bind-Value="answer.Answer" Class="me-2" />
                                                        <MudNumericField T="decimal" @bind-Value="answer.Points" Class="me-2" Max="@(question.Points + question.BonusPoints)" />
                                                        <MudText Color="@GetResultColor(answer.Result)">
                                                            @(answer.Result switch
                                                            {
                                                                0 => "Incorrect",
                                                                1 => "Partial",
                                                                2 => "Correct",
                                                                _ => "Unknown"
                                                            })
                                                        </MudText>
                                                    </MudStack>
                                                }
                                                else
                                                {
                                                    <MudText>
                                                        Answer: @question.Answer —
                                                        @answer.Answer — @answer.Points — @answer.Result
                                                    </MudText>
                                                }
                                            </MudListItem>
                                        }
                                    </MudList>

                                    <div class="mt-2">
                                        <b>Bonus Points:</b>
                                        @if (editable)
                                        {
                                            <MudNumericField T="decimal" @bind-Value="segmentResult.BonusPoints" Max="@segment.BonusPoints" />
                                        }
                                        else
                                        {
                                            @segmentResult.BonusPoints
                                        }
                                    </div>
                                </MudListItem>
                            }
                        </MudList>
                    }
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="mt-4" OnClick="SaveRoundResult" Disabled="editionRated">
                        Save Answers
                    </MudButton>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" Class="mt-4" OnClick="GradeTeamAnswers" Disabled="editionRated">
                        Grade Answers
                    </MudButton>
                </MudPaper>
            }
        </div>
    }
</MudPaper>

<MudStack Class="pt-4" Spacing="2" AlignItems="AlignItems.Start">
    <MudStack Row AlignItems="AlignItems.Start" Spacing="1">
        <div style="width:16px;height:16px;background-color:lightcoral;border:1px solid #ccc;"></div>
        <MudText Typo="Typo.caption">Not Entered</MudText>
    </MudStack>

    <MudStack Row AlignItems="AlignItems.Start" Spacing="1">
        <div style="width:16px;height:16px;background-color:lightsalmon;border:1px solid #ccc;"></div>
        <MudText Typo="Typo.caption">No Answers</MudText>
    </MudStack>
</MudStack>

@if (!allAnswersEnteredPopUp)
{
    <MudPaper Elevation="8" Square="false"
              Style="position:fixed; top:50%; left:50%; transform: translate(-50%, -50%);
                     z-index:2000; padding:24px; max-width:400px; text-align:center; background:white;">
        <MudText Typo="Typo.h6" Class="mb-4">
            Not entering all the answers will result in less accurate rating calculation
        </MudText>
        <MudStack Row Justify="Justify.Center" Spacing="2">
            <MudButton Color="Color.Warning" Variant="Variant.Filled" OnClick="Proceed">
                Proceed
            </MudButton>
            <MudButton Color="Color.Error" Variant="Variant.Filled" OnClick="ClosePopup">
                Exit
            </MudButton>
        </MudStack>
    </MudPaper>

    <MudOverlay Visible="true" Opacity="0.4" />
}


@code {
    [Parameter]
    public int EditionId { get; set; }

    private List<QuizEditionResultDetailedDto> results = new();
    private List<QuizRoundDto> rounds = new();

    private int? resultId;
    private int? selectedRoundId;
    private QuizRoundDto selectedRound = null!;
    private bool newRound = false;

    private QuizRoundResultDetailedDto? roundResult = null!;
    private QuizRoundResultDetailedDto tempRoundResult = null!;
    private NewQuizRoundResultDto newRoundResult = null!;
    private NewQuizRoundResultDto tempNewRoundResult = null!;
    private TeamBreifDto selectedTeam = null!;
    private bool editable;
    private bool editionRated = false;
    private bool canCalculateRank = false;
    private bool allAnswersEnteredPopUp = true;

    protected override async Task OnInitializedAsync()
    {
        rounds = (await QuestionService.GetRounds(EditionId)).ToList() ?? new();

        rounds = rounds
            .OrderBy(r => r.Number)
            .Select(r =>
            {
                r.QuizSegments = r.QuizSegments
                    .OrderBy(s => s.Number)
                    .Select(s =>
                    {
                        s.Questions = s.Questions
                            .OrderBy(q => q.Number)
                            .ToList();
                        return s;
                    }).ToList();
                return r;
            }).ToList();

        editionRated = await EloCalculatorService.IsEditionRated(EditionId);
        results = (await AnswerService.GetEditionResultsDetailed(EditionId)).ToList() ?? new();

        results = results.OrderBy(x => x.Rank).ToList();

        canCalculateRank = !editionRated && AllResultsEnteredForAllRounds();
    }

    private void SelectRound(int teamId, int roundId)
    {
        resultId = teamId;

        if (selectedRoundId != roundId)
        {
            selectedRoundId = roundId;
            selectedRound = rounds.FirstOrDefault(x => x.Id == selectedRoundId)!;
        }

        roundResult = results
            .FirstOrDefault(r => r.Id == resultId.Value && r.Rounds.Any(rr => rr.RoundId == selectedRoundId.Value))?
            .Rounds.FirstOrDefault(rr => rr.RoundId == selectedRoundId.Value);

        if (roundResult == null)
        {
            newRoundResult = CreateRoundResult(teamId, roundId);
            newRound = true;
            tempNewRoundResult = newRoundResult;
        }
        else
        {
            roundResult = FillRoundResult(teamId, roundId);
            newRound = false;
            tempRoundResult = roundResult;
        }

        selectedTeam = results.FirstOrDefault(r => r.Id == resultId.Value)?.Team!;
        editable = true;
    }

    private QuizRoundResultDetailedDto FillRoundResult(int teamId, int roundId)
    {
        var selectedResult = results?.FirstOrDefault(r => r.Id == teamId);
        var selectedRound = rounds?.FirstOrDefault(r => r.Id == roundId);
        roundResult = selectedResult?.Rounds.FirstOrDefault(rr => rr.RoundId == roundId);

        roundResult!.QuizSegmentResults ??= new List<QuizSegmentResultDetailedDto>();

        if (selectedRound != null)
        {
            foreach (var segment in selectedRound.QuizSegments)
            {
                var segResult = roundResult.QuizSegmentResults.FirstOrDefault(s => s.SegmentId == segment.Id);

                if (segResult == null)
                {
                    segResult = new()
                    {
                        RoundResultId = roundResult.Id,
                        SegmentId = segment.Id,
                        QuizAnswers = new List<QuizAnswerDetailedDto>()
                    };

                    roundResult.QuizSegmentResults = roundResult.QuizSegmentResults.Append(segResult).ToList();
                }

                foreach (var question in segment.Questions)
                {
                    var answer = segResult.QuizAnswers.FirstOrDefault(a => a.QuestionId == question.Id);

                    if (answer == null)
                    {
                        answer = new QuizAnswerDetailedDto
                            {
                                QuestionId = question.Id,
                                Answer = string.Empty,
                                Points = 0,
                                Result = 0,
                            };

                        segResult.QuizAnswers = segResult.QuizAnswers.Append(answer).ToList();
                    }
                }
            }
        }

        return roundResult;
    }

    private NewQuizRoundResultDto CreateRoundResult(int teamId, int roundId)
    {
        var selectedResult = results?.FirstOrDefault(r => r.Id == teamId);
        var selectedRound = rounds?.FirstOrDefault(r => r.Id == roundId);
        newRoundResult = null!;

        newRoundResult = new NewQuizRoundResultDto
            {
                RoundId = roundId,
                EditionResultId = (int)resultId!,
                Points = 0,
                QuizSegmentResults = new List<NewQuizSegmentResultDto>()
            };

        if (selectedRound != null)
        {
            foreach (var segment in selectedRound.QuizSegments)
            {

                var segResult = new NewQuizSegmentResultDto
                    {
                        SegmentId = segment.Id,
                        BonusPoints = 0,
                        QuizAnswers = new List<NewQuizAnswerDto>(),
                    };

                newRoundResult.QuizSegmentResults = newRoundResult.QuizSegmentResults.Append(segResult).ToList();

                foreach (var question in segment.Questions)
                {
                    var answer = new NewQuizAnswerDto
                        {
                            QuestionId = question.Id,
                            Answer = string.Empty,
                            Points = 0,
                            Result = 0,
                        };
                    segResult.QuizAnswers = segResult.QuizAnswers.Append(answer).ToList();
                }
            }
        }

        return newRoundResult;
    }

    private bool CanSave(NewQuizRoundResultDto result)
    {
        return result != null;
    }

    private async Task SaveRoundResult()
    {
        if (newRound)
            await AnswerService.AddTeamRoundPointsDetailed(tempNewRoundResult);
        else
            await AnswerService.UpdateTeamRoundPointsDetailed(tempRoundResult);

        results = (await AnswerService.GetEditionResultsDetailed(EditionId)).ToList() ?? new();

        results = results.OrderBy(x => x.Rank).ToList();

        tempNewRoundResult = null!;
        tempRoundResult = null!;
        resultId = null!;
        selectedRoundId = null!;

        StateHasChanged();
    }

    private int FindCurrentEditableRoundNumber()
    {
        foreach (var round in rounds.OrderBy(r => r.Number))
        {
            foreach (var result in results)
            {
                var r = result.Rounds.FirstOrDefault(rr => rr.RoundId == round.Id);
                if (r == null)
                    return round.Number;
            }
        }
        return -1;
    }

    private QuizQuestionDto GetQuestion(int questionId)
    {
        if (selectedRound == null)
            return new();

        foreach (var segment in selectedRound!.QuizSegments)
        {
            var question = segment.Questions.FirstOrDefault(q => q.Id == questionId);

            if (question != null)
                return question;
        }

        return new();
    }

    private QuizSegmentDto GetSegment(int segmentId)
    {
        if (selectedRound == null)
            return new();

        selectedRound!.QuizSegments.FirstOrDefault(x => x.Id == segmentId);

        return new();
    }

    private QuizQuestionDto GetAnswer(int questionId)
    {
        if (selectedRound == null)
            return new();

        foreach (var segment in selectedRound!.QuizSegments)
        {
            var question = segment.Questions.FirstOrDefault(q => q.Id == questionId);

            if (question != null)
                return question;
        }

        return new();
    }

    private async Task RankTeams()
    {
        var newResults = await AnswerService.RankTeamsOnEdition(EditionId);

        if (newResults != null)
        {
            await OnInitializedAsync();
        }
    }

    private async Task CalculateRatings()
    {
        allAnswersEnteredPopUp = AllResultsEnteredForAllQuestions();

        if (!allAnswersEnteredPopUp)
            return;


        var success = await EloCalculatorService.CalculateEditionElo(EditionId);

        if (success)
            editionRated = true;

        canCalculateRank = false;
        await Task.Delay(10);
        StateHasChanged();
    }

    private async Task Proceed()
    {
        allAnswersEnteredPopUp = true;

        var success = await EloCalculatorService.CalculateEditionElo(EditionId);

        if (success)
            editionRated = true;

        canCalculateRank = false;
        await Task.Delay(10);
        StateHasChanged();
    }

    private void ClosePopup()
    {
        allAnswersEnteredPopUp = true;
    }

    private bool AllResultsEnteredForAllRounds()
    {
        if (rounds == null || results == null)
            return false;

        var requiredRoundIds = rounds.Select(r => r.Id).ToHashSet();

        return results.All(result =>
            result.Rounds != null &&
            requiredRoundIds.All(roundId =>
                result.Rounds.Any(rr => rr.RoundId == roundId)
            )
        );
    }

    private bool AllResultsEnteredForAllQuestions()
    {
        var expectedSegmentsByRoundId = rounds
            .ToDictionary(r => r.Id, r => r.QuizSegments.Select(qs => qs.Id).ToHashSet());

        var allSegments = results.All(result =>
            result.Rounds != null &&
            result.Rounds.All(rr =>
                expectedSegmentsByRoundId.TryGetValue(rr.RoundId, out var expectedIds) &&
                rr.QuizSegmentResults != null &&
                rr.QuizSegmentResults.Any() &&
                rr.QuizSegmentResults.All(qsr => expectedIds.Contains(qsr.SegmentId))
            )
        );

        return allSegments;
    }

    private bool ShouldShowBreakTieButton(QuizEditionResultDetailedDto team)
    {
        if (!AllResultsEnteredForAllRounds())
            return false;

        if (results == null)
            return false;

        var tiedTopRanks = results
            .Where(r => r.Rank <= 3)
            .GroupBy(r => r.Rank)
            .Where(g => g.Count() > 1)
            .SelectMany(g => g)
            .Select(r => r.Id)
            .ToHashSet();

        int total = results.Count;
        var tiedNearBottom = results
            .Where(r => r.Rank >= total - 1)
            .GroupBy(r => r.Rank)
            .Where(g => g.Count() > 1)
            .SelectMany(g => g)
            .Select(r => r.Id)
            .ToHashSet();

        return tiedTopRanks.Contains(team.Id) || tiedNearBottom.Contains(team.Id);
    }

    private async Task BreakTieAsync(int promotedId)
    {
        await AnswerService.BreakTie(promotedId, EditionId);
        await OnInitializedAsync();
    }

    private async Task GradeTeamAnswers()
    {
        if (newRound)
            await AnswerService.GradeTeamAnswers(tempNewRoundResult);
        else
            await AnswerService.GradeExistingTeamAnswers(tempRoundResult);

        results = (await AnswerService.GetEditionResultsDetailed(EditionId)).ToList() ?? new();

        results = results.OrderBy(x => x.Rank).ToList();

        tempNewRoundResult = null!;
        tempRoundResult = null!;
        resultId = null!;
        selectedRoundId = null!;

        StateHasChanged();
    }

    private NewQuizSegmentResultDto GetNewSegmentResult(int segmentId)
    {
            return tempNewRoundResult!.QuizSegmentResults.FirstOrDefault(x => x.SegmentId == segmentId)!;
    }

    private NewQuizAnswerDto GetNewAnswer(NewQuizSegmentResultDto segmentResult, int questionId)
    {
            return segmentResult!.QuizAnswers.FirstOrDefault(x => x.QuestionId == questionId)!;
    }

    private QuizSegmentResultDetailedDto GetSegmentResult(int segmentId)
    {
            return tempRoundResult!.QuizSegmentResults.FirstOrDefault(x => x.SegmentId == segmentId)!;
    }

    private QuizAnswerDetailedDto GetAnswer(QuizSegmentResultDetailedDto segmentResult, int questionId)
    {
            return segmentResult!.QuizAnswers.FirstOrDefault(x => x.QuestionId == questionId)!;
    }

    private Color GetResultColor(int result) => result switch
    {
        0 => Color.Error,
        1 => Color.Warning,
        2 => Color.Success,
        _ => Color.Default
    };
}